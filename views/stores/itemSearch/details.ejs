<% include ../../partials/head/head %>
<body>
<% include ../../partials/head/flash %>
<section id='body'>
<div class='row container mx-auto'>
    <div class='col-12 col-md-6'>
        <h3><%= callType %></h3>
        <h4><%= size.item._description %></h4>
        <h5><%= size.item._size_text %>: <%= size._size %></h5>
        <div class='row'>
            <% if (size._nsns && callType === 'issue') { %>
                <div class='col-12 bordered mb-2'>
                    <h6>Select NSN</h6>
                    <input class='form-control' type='text' id='nsnSearch' onkeyup='searchTable("nsns", "nsnSearch")' placeholder='Search for NSNs...'>
                    <select class='form-control w-100' id='nsns' type='text' size='2'>
                        <% size.nsns.forEach(nsn => { %>
                            <option value='<%= nsn.nsn_id %>'><%= nsn._nsn %></option>
                        <% }); %>
                    </select>
                </div>
            <% } %>
            <% if (size._serials) { %>
                <div class='col-12 bordered mb-2'>
                    <h6>Select Serial</h6>
                    <input class='form-control' type='text' id='serialSearch' onkeyup='searchTable("serials", "serialSearch")' placeholder='Search for Serials...'>
                    <select class='form-control w-100' id='serials' type='text' size='2'>
                        <% size.serials.forEach(serial => { %>
                            <option value='<%= serial.serial_id %>'><%= serial._serial %></option>
                        <% }); %>
                    </select>
                </div>
            <% } else { %>

            <% } %>
            <% if (callType === 'issue' || callType === 'receipt') { %>
                <div class='col-12 bordered mb-2'>
                    <h6>Issue From Location</h6>
                    <input class='form-control' type='text' id='stockSearch' onkeyup='searchTable("stocks", "stockSearch")' placeholder='Search for stock...'>
                    <select class='form-control w-100' id='stocks' type='text' size='2'>
                        <% size.stocks.forEach(stock => { %>
                            <option value='{"id":<%= stock.stock_id %>,"qty":<%= stock._qty %>}'><%= stock.location._location %>, Qty: <%= stock._qty %></option>
                        <% }); %>
                    </select>
                </div>
            <% } %>
            <div class='col-12 bordered mb-2'>
                <div class='row'>
                    <div class='col-4 col-md-2'>
                        <label class='col-form-label' for='qty'>Qty</label>
                    </div>
                    <div class='col-8 col-md-4'>
                        <input class='form-control' type='number' input='numeric' id='qty' value='1'>
                    </div>
                    <div class='col-md-6'>
                        <button class='btn btn-success w-100' onclick='javascript:addSize()'>Add Size</button>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class='row'>
                    <div class='col-6 mb-2'>
                        <a class='btn btn-primary w-100' href='/stores/itemSearch?callType=<%= callType %>&supplier_id=<%= supplier_id %>'>New Search</a>
                    </div>
                    <div class='col-6 mb-2'>
                        <a class='btn btn-primary w-100' href='/stores/itemSearch/item/<%= size.item_id %>?d=<%= size.item._description %>&callType=<%= callType %>&supplier_id=<%= supplier_id %>'>Back</a>
                    </div>
                    <div class='col-12'>
                        <a class='btn btn-danger w-100' href='javascript:close()'>Finished Adding Items</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<% include ../../partials/foot/js %>
<script src='/js/selectSearch.js'></script>
<script>
function addSize() {
    let qty    = Number(document.querySelector('#qty').value) || 0,
        stocks = document.querySelector('#stocks'),
        <% if (size._nsns) { %>   nsns    = document.querySelector('#nsns'),<% } %>
        <% if (size._serials) { %>serials = document.querySelector('#serials'),<% } %>
        callType = '<%= callType %>';
    if ((callType === 'issue'   && (stocks.selectedIndex === -1 ||
                             <% if (size._nsns) { %>nsns.selectedIndex === -1 ||<% } %>
                                    qty === 0)) || 
        (callType === 'receipt' && (stocks.selectedIndex === -1 ||
                                    qty === 0)) || 
        (callType === 'order'   &&  qty === 0) || 
        (callType === 'request' &&  qty === 0)) {
        alert('Select all fields');
    } else {
        if (window.opener.addSize) {
            let selected = {}
            if (callType === 'issue' || callType === 'receipt') {
                selected.stock_id = JSON.parse(stocks.value).id;
                selected.stocks = [];
                <%- JSON.stringify(size.stocks) %>.forEach(stock => {
                    selected.stocks.push({stock_id: stock.stock_id, _location: stock.location._location, qty: stock._qty});
                });
                <% if (size._nsns) { %>
                    if (callType === 'issue') {
                        selected.nsn_id    = Number(nsns.value);
                        selected.nsns = [];
                        <%- JSON.stringify(size.nsns) %>.forEach(nsn => {
                            selected.nsns.push({nsn_id: nsn.nsn_id, _nsn: nsn._nsn});
                        });
                    };
                <% } %>
            };
            <% if (size._serials) { %>
                selected.qty = 1;
                selected.serial_id = Number(serials.value);
                selected.serials = [];
                <%- JSON.stringify(size.serials) %>.forEach(serial => {
                    selected.serials.push({serial_id: serial.serial_id, _serial: serial._serial});
                });
            <% } else { %>
                selected.qty = qty;
            <% } %>
            selected.size_id = <%= size.size_id %>;
            selected.description  = '<%= size.item._description %>';
            selected.size         = '<%= size._size %>';

            alert(window.opener.addSize(selected))
        } else alert('unable to find target window!\nClose this window and try again');
    };
};
</script>
<% include ../../partials/foot/htmlClose %>
