<%- include(`${partials}/head/full`) %>
<section class='mb-2'>
    <nav class='navbar navbar-expand navbar-light bg-nav'>
        <ul class='navbar-nav mr-auto'>
            <%- include(`${partials}/breadcrumb`, {href: '/stores',		  text: 'Stores'}) %>
            <%- include(`${partials}/breadcrumb`, {href: '/stores/items', text: 'Items'}) %>
			<% if (permissions.item_add) { %>
				<%- include(`${partials}/breadcrumb`, {html: '<i class="fas fa-plus"></i>', href: 'javascript:$("#mdl_add_item").modal("show")'}) %>
			<% } %>
			<%- include(`${partials}/reload`) %>
            <%- include(`${partials}/spinner`, {id: 'items'}) %>
        </ul>
    </nav>
</section>
<section class='container'>
	<%- include(`${partials}/inputs/select`, {id: 'sel_categories', title: 'Category'}) %>
	<%- include(`${partials}/inputs/select`, {id: 'sel_groups', 	title: 'Groups'}) %>
	<%- include(`${partials}/inputs/select`, {id: 'sel_types', 		title: 'Types'}) %>
	<%- include(`${partials}/inputs/select`, {id: 'sel_subtypes', 	title: 'Subtypes'}) %>
	<%- include(`${partials}/inputs/select`, {id: 'sel_genders', 	title: 'Genders'}) %>
	<input class='form-control' type='text' id='itemSearch' onkeyup='searchTable(this)' placeholder='Search by description...'>
	<table class='table table-sm table-hover'>
		<thead class='thead-dark'>
			<th class='w-100' onclick='sortTable(0, "tbl_items")'>Description</th>
			<th><i class='fas fa-search'></i></th>
		</thead>
		<tbody id='tbl_items'>
		</tbody>
	</table>
    <% if (permissions.item_add) { %>
        <div id='mdl_add_item' class="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <form class="modal-content" id='form_add_item'>
                    <div class="modal-header">
                        <h5 class="modal-title">Add Item</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <%- include(`${partials}/inputs/text`, {title: 'Description', name: 'item[_description]', placeholder: 'Required', maxLength: 45, required: true}) %>
						<%- include(`${partials}/inputs/select`, {id: 'sel_categories_add', title: 'Category'}) %>
						<%- include(`${partials}/inputs/select`, {id: 'sel_groups_add', 	title: 'Groups'}) %>
						<%- include(`${partials}/inputs/select`, {id: 'sel_types_add', 		title: 'Types'}) %>
						<%- include(`${partials}/inputs/select`, {id: 'sel_subtypes_add', 	title: 'Subtypes'}) %>
						<%- include(`${partials}/inputs/select`, {id: 'sel_genders_add', 	title: 'Genders'}) %>
						<%- include(`${partials}/inputs/text`, {title: 'Size Text',	  name: 'item[_size_text]',	  placeholder: 'Required', maxLength: 45, required: true}) %>
					</div>
                    <div class="modal-footer">
                        <input type="submit" class="btn btn-success w-100 confirm" value='Save Item'>
                    </div>
                </form>
            </div>
        </div>
    <% } %>
</section>
<%- include(`${partials}/foot/full`) %>
<!-- get, XHRsend and spinner from item options -->
<script src="/js/add.js"></script>
<script src="/js/search/table.js"></script>
<script src="/js/stores/items/index/items.js"></script>
<script src="/js/data/addFormListener.js"></script>
<script src="/js/data/send.js"></script>
<script src="/js/data/XHRsend.js"></script>
<script src="/js/spinner.js"></script>
<script src="/js/get.js"></script>
<% [{table: 'categories', singular: 'category'}, {table: 'genders', singular: 'gender'}].forEach(e => { %>
	<script async>
		let sel_<%= e.table %> = document.querySelector(`#sel_<%= e.table %>`);
		if (sel_<%= e.table %>) {
			get(
				function (results, options) {
					sel_<%= e.table %>.innerHTML= '';
					sel_<%= e.table %>.appendChild(new Option({text: '', value: '', selected: true}).e);
					results.forEach(r => {
						sel_<%= e.table %>.appendChild(
							new Option({
								text: r['_<%= e.singular %>'],
								value: r['<%= e.singular %>_id']
							}).e
						)
					});
				},
				{
					table: '<%= e.table %>',
					query: []
				}
			);
		};
		getItems();
	</script>
	<% if (permissions.item_add) { %>
		<script async>
			let sel_<%= e.table %>_add = document.querySelector(`#sel_<%= e.table %>_add`);
			if (sel_<%= e.table %>_add) {
				get(
					function (results, options) {
						sel_<%= e.table %>_add.innerHTML= '';
						sel_<%= e.table %>_add.appendChild(new Option({text: '', value: '', selected: true}).e);
						results.forEach(r => {
							sel_<%= e.table %>_add.appendChild(
								new Option({
									text: r['_<%= e.singular %>'],
									value: r['<%= e.singular %>_id']
								}).e
							)
						});
					},
					{
						table: '<%= e.table %>',
						query: []
					}
				);
			};
		</script>
	<% } %>
<% }) %>
<script>
	window.addEventListener( "load", () => {
		let sel_categories = document.querySelector('#sel_categories'),
			sel_groups 	   = document.querySelector('#sel_groups'),
			sel_types 	   = document.querySelector('#sel_types'),
			sel_subtypes   = document.querySelector('#sel_subtypes');
		if (sel_categories && sel_groups) {
			sel_categories.addEventListener('change', function () {
				sel_groups.innerHTML = '';
				sel_types.innerHTML = '';
				sel_subtypes.innerHTML = '';
				if (sel_categories.value !== '') {
					get(
						function (groups, options) {
							sel_groups.appendChild(new Option({text: '', value: '', selected: true}).e);
							groups.forEach(e => {
								sel_groups.appendChild(
									new Option({
										text: e._group,
										value: e.group_id
									}).e
								)
							});
						},
						{
							table: 'groups',
							query: [`category_id=${sel_categories.value}`]
						}
					);
				};
				getItems();
			});
		};
		if (sel_groups && sel_types) {
			sel_groups.addEventListener('change', function () {
				sel_types.innerHTML = '';
				sel_subtypes.innerHTML = '';
				if (sel_groups.value !== '') {
					get(
						function (types, options) {
							sel_types.appendChild(new Option({text: '', value: '', selected: true}).e);
							types.forEach(e => {
								sel_types.appendChild(
									new Option({
										text: e._type,
										value: e.type_id
									}).e
								)
							});
						},
						{
							table: 'types',
							query: [`group_id=${sel_groups.value}`]
						}
					);
				};
				getItems();
			});
		};
		if (sel_types && sel_subtypes) {
			sel_types.addEventListener('change', function () {
				sel_subtypes.innerHTML = '';
				if (sel_types.value !== '') {
					get(
						function (subtypes, options) {
							sel_subtypes.appendChild(new Option({text: '', value: '', selected: true}).e);
							subtypes.forEach(e => {
								sel_subtypes.appendChild(
									new Option({
										text: e._subtype,
										value: e.subtype_id
									}).e
								)
							});
						},
						{
							table: 'subtypes',
							query: [`type_id=${sel_types.value}`]
						}
					);
					getItems();
				};
			});
		};
	});
</script>
<% if (permissions.item_add) { %>
	<script>
		window.addEventListener( "load", () => {
			let sel_categories_add = document.querySelector('#sel_categories_add'),
				sel_groups_add 	   = document.querySelector('#sel_groups_add'),
				sel_types_add 	   = document.querySelector('#sel_types_add'),
				sel_subtypes_add   = document.querySelector('#sel_subtypes_add');
			if (sel_categories_add && sel_groups_add) {
				sel_categories_add.addEventListener('change', function () {
					sel_groups_add.innerHTML = '';
					sel_types_add.innerHTML = '';
					sel_subtypes_add.innerHTML = '';
					if (sel_categories_add.value !== '') {
						get(
							function (groups, options) {
								sel_groups_add.appendChild(new Option({text: '', value: '', selected: true}).e);
								groups.forEach(e => {
									sel_groups_add.appendChild(
										new Option({
											text: e._group,
											value: e.group_id
										}).e
									)
								});
							},
							{
								table: 'groups',
								query: [`category_id=${sel_categories_add.value}`]
							}
						);
					};
				});
			};
			if (sel_groups_add && sel_types_add) {
				sel_groups_add.addEventListener('change', function () {
					sel_types_add.innerHTML = '';
					sel_subtypes_add.innerHTML = '';
					if (sel_groups_add.value !== '') {
						get(
							function (types, options) {
								sel_types_add.appendChild(new Option({text: '', value: '', selected: true}).e);
								types.forEach(e => {
									sel_types_add.appendChild(
										new Option({
											text: e._type,
											value: e.type_id
										}).e
									)
								});
							},
							{
								table: 'types',
								query: [`group_id=${sel_groups_add.value}`]
							}
						);
					};
				});
			};
			if (sel_types_add && sel_subtypes_add) {
				sel_types_add.addEventListener('change', function () {
					sel_subtypes_add.innerHTML = '';
					if (sel_types_add.value !== '') {
						get(
							function (subtypes, options) {
								sel_subtypes_add.appendChild(new Option({text: '', value: '', selected: true}).e);
								subtypes.forEach(e => {
									sel_subtypes_add.appendChild(
										new Option({
											text: e._subtype,
											value: e.subtype_id
										}).e
									)
								});
							},
							{
								table: 'subtypes',
								query: [`type_id=${sel_types_add.value}`]
							}
						);
					};
				});
			};
			addFormListener(
				'form_add_item',
				'POST',
				'/stores/items',
				{onComplete: getItems}
			);
		});
	</script>
<% } %>
<%- include(`${partials}/foot/htmlClose`) %>