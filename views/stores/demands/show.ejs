<% include ../../partials/head/full %>
<section class='mb-2'>
	<nav class='navbar navbar-expand navbar-light bg-nav'>
		<ul class='navbar-nav mr-auto'>
			<li class='nav-item'>
				<a class='nav-link stores_nav' href='/stores'>Stores</a>
			</li>
			<li class='nav-item'>
				<a class='nav-link stores_nav' href='/stores/demands'>Demands</a>
			</li>
			<li class='nav-item'>
				<a class='nav-link stores_nav' href='/stores/demands/<%= demand.demand_id %>'>
					<%= demand.demand_id %>
				</a>
			</li>
		</ul>
	</nav>
</section>
<section class='container'>
	<div class='row'>
		<div class='col-12 col-lg-6 col-xl-5 mb-3 bordered'>
			<% if (demand._filename) { %>
				<a class='float-left btn btn-primary mr-1' href='/stores/demands/<%= demand.demand_id %>/download'>
					<i class='fas fa-file-download'></i>
				</a>
			<% } %>
			<% if (permissions.demands_delete) { %>
				<form action='/stores/demands/<%= demand.demand_id %>?_method=DELETE' method='POST'>
					<button class='float-left btn btn-danger confirm'>
						<i class='fas fa-trash-alt'></i>
					</button>
				</form>
			<% }; %>
			<h4 class='mb-3'>Details</h4>
			<div class='row'>
				<div class='col-sm-4'>
					<label class='col-form-label'>Supplier:</label>
				</div>
				<div class='col-sm-6'>
					<input class='form-control' type='text' value='<%= demand.supplier._name %>' readonly>
				</div>
				<div class='col-sm-2'>
					<a class="float-right btn btn-primary" href='/stores/suppliers/<%= demand.supplier_id %>'><i class='fas fa-search'></i></a class="btn btn-primary">
				</div>
			</div>
			<div class='row'>
				<div class='col-sm-4'>
					<label class='col-form-label'>Raised By:</label>
				</div>
				<div class='col-sm-6'>
						<input class='form-control' type='text' value='<%= demand.user.rank._rank %> <%= demand.user._name %>, <%= demand.user._ini %>' readonly>
				</div>
				<div class='col-sm-2'>
					<a class="float-right btn btn-primary" href='/stores/users/<%= demand.user_id %>'><i class='fas fa-search'></i></a>
				</div>
			</div>
			<div class='row'>
				<div class='col-sm-4'>
					<label class='col-form-label'>Date:</label>
				</div>
				<div class='col-sm-8'>
					<input class='form-control' type='text' value='<%= demand._date.toDateString() %>' readonly>
				</div>
			</div>
			<div class='row'>
				<div class='col-sm-4'>
					<label class='col-form-label'>Complete:</label>
				</div>
				<div class='col-sm-8'>
					<input class='form-control form-control-sm' type='checkbox' disabled<% if (demand._complete) { %> checked<% } %>>
				</div>
			</div>
		</div>
		<% if (permissions.access_notes) { %> 
			<div class='col-12 col-lg-6 col-xl-7 mb-3 bordered'>
				<% if (permissions.notes_add) { %>
					<a class='float-left btn btn-success' href='/stores/notes/new?table=demands&id=<%= demand.demand_id %>'>
						<i class='fas fa-plus'></i>
					</a>
				<% } %>
				<% include ../../partials/noteTable %>
			</div>
		<% } %>
		<div class='col-12 col-lg-6 col-xl-12 mb-3 bordered'>
			<div class='row'>
				<div class='col-3'>
					<label class='col-form-label text-right' for='received'>Received Lines:</label>
				</div>
				<div class='col-9'>
					<select id='received' class='form-control form-control-sm' type='text' onchange=filterSelects()>
						<option value='1' <% if (query.received === 1) { %>selected<% } %> >Include</option>
						<option value='2' <% if (query.received === 2) { %>selected<% } %> >Exclude</option>
						<option value='3' <% if (query.received === 3) { %>selected<% } %> >Only</option>
					</select>
				</div>
			</div>
			<form id='requestForm' action='/stores/demands/<%= demand.demand_id %>?_method=PUT' method='POST'>
				<button class='btn btn-success w-100 mb-3 confirm'>Action Selected Lines</button>
				<table class='table table-sm table-hover mx-auto w-100'>
					<thead class='thead-dark'>
						<th class='w-30' onclick="sortTable(0, 'demandTable')">Item</th>
						<th class='w-20' onclick="sortTable(1, 'demandTable')">Size</th>
						<th class='w-20' onclick="sortTable(2, 'demandTable')">Quantity</th>
						<th class='w-30' onclick="sortTable(3, 'demandTable')">Action</th>
					</thead>
					<tbody id='demandTable'>
						<% if (demand.lines) { %>
							<% demand.lines.forEach(line => { %>
								<tr>
									<td>
										<a class='float-right btn btn-sm btn-primary' href='/stores/items/<%= line.item_size.item_id %>'><i class='fas fa-search'></i></a>
										<%= line.item_size.item._description %>
									</td>
									<td>
										<a class='float-right btn btn-sm btn-primary' href='/stores/item_sizes/<%= line.item_size.itemsize_id %>'><i class='fas fa-search'></i></a>
										<%= line.item_size._size %>
									</td>
									<td>
										<%= line._qty %>
									</td>
									<td>
										<% if (line._status === 'Cancelled' || line._status === 'Received') { %>
											<%= line._status %>
										<% } else { %>
											<select id='action<%= line.line_id %>' type='select' class='form-control form-control-sm' name='actions[]'>
												<option value='{"action":null}'></option>
												<option value='{"action":"cancel","line_id":<%= line.line_id %>}'>Cancel</option>
												<% line.item_size.stocks.forEach(stock => { %>
													<option value='{"action":"receive","line_id": <%= line.line_id %>,"stock_id":<%= stock.stock_id %>}'>
														Receive to <%= stock.location._location %>
													</option>
												<% }) %>
											</select>
										<% } %>
									</td>
								</tr>
							<% }) %>
						<% } %>
					</tbody>
				</table>
			</form>
		</div>
	</div>
</section>
<% include ../../partials/foot/full %>
<script>
    function filterSelects() {
        filter(['received', 'system'], '/stores/demands/<%= demand.demand_id %>');
    };
</script>
<% include ../../partials/foot/htmlClose %>