<% include ../../partials/head/full %>
<section class='mb-2'>
	<nav class='navbar navbar-expand navbar-light bg-nav'>
		<ul class='navbar-nav mr-auto'>
			<li class='nav-item'>
				<a class='nav-link stores_nav' href='/stores'>Stores</a>
			</li>
			<li class='nav-item'>
				<a class='nav-link stores_nav' href='/stores/demands'>Demands</a>
			</li>
			<li class='nav-item'>
				<a class='nav-link stores_nav' href='/stores/demands/<%= demand.demand_id %>'>
					<%= demand.demand_id %>
				</a>
			</li>
		</ul>
	</nav>
</section>
<section class='container'>
	<ul class="nav nav-tabs" id="mainTab" role="tablist">
        <li class="nav-item">
            <a class="nav-link" id="details-tab" data-toggle="tab" href="#details" role="tab" aria-controls="details" aria-selected="true">
                Details
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="lines-tab" data-toggle="tab" href="#lines" role="tab" aria-controls="lines" aria-selected="true">
                Lines (<%= demand.lines.length %>)
            </a>
        </li>
        <% if (permissions.access_notes) { %>
            <li class="nav-item">
                <a class="nav-link" id="notes-tab" data-toggle="tab" href="#notes" role="tab" aria-controls="notes" aria-selected="true">
                    Notes (<%= notes.notes.length %>)
                </a>
            </li>
        <% } %>
    </ul>
    <div class="tab-content pt-3" id="myTabContent">
        <div class="tab-pane fade" id="details" role="tabpanel" aria-labelledby="details-tab">
            <div class="container">
				<% if (demand._filename) { %>
					<a class='float-left btn btn-primary m-1' href='/stores/demands/<%= demand.demand_id %>/download'>
						<i class='fas fa-file-download'></i>
					</a>
				<% } %>
				<% if (permissions.demand_delete) { %>
					<form id='deleteForm'>
						<button class='float-left m-1 btn btn-danger confirm'>
							<i class='fas fa-trash-alt'></i>
						</button>
					</form>
				<% }; %>
				<div class="input-group mb-1">
					<div class="input-group-prepend w-20">
						<span class="input-group-text w-100">Supplier</span>
					</div>
					<p class="form-control"><%= demand.supplier._name %></p>
					<div class="input-group-append">
						<a class="float-right btn btn-primary" href='/stores/suppliers/<%= demand.supplier_id %>'>
							<i class='fas fa-search'></i>
						</a>
					</div>
				</div>
				<div class="input-group mb-1">
					<div class="input-group-prepend w-20">
						<span class="input-group-text w-100">Raised By</span>
					</div>
					<p class="form-control"><%= demand.user.rank._rank %> <%= demand.user._name %>, <%= demand.user._ini %></p>
					<div class="input-group-append">
						<a class="float-right btn btn-primary" href='/stores/users/<%= demand.user_id %>'>
							<i class='fas fa-search'></i>
						</a>
					</div>
				</div>
				<div class="input-group mb-1">
					<div class="input-group-prepend w-20">
						<span class="input-group-text w-100">Date</span>
					</div>
					<p class="form-control"><%= demand._date.toDateString() %></p>
				</div>
				<div class="input-group mb-1">
					<div class="input-group-prepend w-20">
						<span class="input-group-text w-100">Complete</span>
					</div>
				<p class="form-control"><% if (demand._complete) { %>Yes<% } else { %>No<% } %></p>
				</div>
			</div>
		</div>
        <div class="tab-pane fade" id="lines" role="tabpanel" aria-labelledby="lines-tab">
            <div class="container">
				<% if (!demand._complete) { %>
					<form action='/stores/demands/<%= demand.demand_id %>?_method=PUT' method='POST'>
						<div class="input-group mb-1">
							<select class="custom-select" name='action'>
								<option value="receive">Receive Selected Lines</option>
								<option value="cancel">Cancel Selected Lines</option>
							</select>
							<div class="input-group-append w-25">
								  <button class="btn btn-success w-100 confirm" type="button">Go</button>
							</div>
						</div>
					<% } %>
					<table class='table table-sm table-hover mx-auto w-100'>
						<thead class='thead-dark'>
							<% if (!demand._complete) { %><th class="w-5"></th><% } %>
							<th class='w-25' onclick="sortTable(0, 'demandTable')">Item</th>
							<th class='w-20' onclick="sortTable(1, 'demandTable')">Size</th>
							<th class='w-10' onclick="sortTable(2, 'demandTable')">Qty</th>
							<th class='w-30' onclick="sortTable(4, 'demandTable')">Status</th>
						</thead>
						<tbody id='demandTable'>
							<% if (demand.lines) demand.lines.forEach(line => { %>
								<tr>
									<% if (!demand._complete) { %>
										<td>
											<input class='form-control form-control-sm' type="checkbox" name='selected[]' value='<%= line.line_id %>'>
										</td>
									<% } %>
									<td>
										<a class='float-right btn btn-sm btn-primary' href='/stores/items/<%= line.size.item_id %>'><i class='fas fa-search'></i></a>
										<%= line.size.item._description %>
									</td>
									<td>
										<a class='float-right btn btn-sm btn-primary' href='/stores/sizes/<%= line.size.size_id %>'><i class='fas fa-search'></i></a>
										<%= line.size._size %>
									</td>
									<td>
										<%= line._qty %>
									</td>
									<td>
										<%= line._status %>
									</td>
								</tr>
							<% }) %>
						</tbody>
					</table>
				<% if (!demand._complete) { %></form><% } %>
			</div>
		</div>
		<% if (permissions.access_notes) { %> 
			<div class="tab-pane fade" id="notes" role="tabpanel" aria-labelledby="notes-tab">
				<div class="container">
					<% include ../../partials/noteTable %>
				</div>
			</div>
		<% } %>
    </div>
	<div class='row'>
</section>
<% include ../../partials/foot/full %>
<script>
    window.addEventListener( "load", function () {
        let form = document.querySelector("#deleteForm");
        form.addEventListener("submit", function (event) {
            event.preventDefault();
            sendData(form, 'DELETE', '/stores/demands/<%= demand.demand_id %>');
        });
    });
    function filterSelects() {
        filter(['system'], '/stores/demands/<%= demand.demand_id %>');
    };
    showTab('<%= show_tab %>');
</script>
<% include ../../partials/foot/htmlClose %>