<% include ../../partials/head/full %>
<section class="mb-2">
	<nav class="navbar navbar-expand navbar-light bg-nav">
		<ul class="navbar-nav mr-auto">
			<li class="nav-item">
				<a class="nav-link stores_nav" href="/stores">Stores</a>
			</li>
			<li class="nav-item">
				<a class="nav-link stores_nav" href="/stores/demands">Demands</a>
			</li>
			<li class="nav-item">
				<a class="nav-link stores_nav" href="/stores/demands/<%= demand.demand_id %>"><%= demand.demand_id %></a>
			</li>
		</ul>
	</nav>
</section>
<section>
	<nav class="navbar navbar-expand navbar-dark bg-dark stores">
		<ul class="navbar-nav mr-auto">
			<li class="nav-item dropdown">
				<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
					Options
				</a>
				<div class="dropdown-menu" aria-labelledby="navbarDropdown">
					<% if (permissions.notes_add) { %>
						<a class="dropdown-item" href="/stores/notes/new?table=demands&id=<%= demand.demand_id %>">Add Note</a>
					<% } %>
					<% if (demand._filename) { %>
					<a class="dropdown-item" href="/stores/demands/<%= demand.demand_id %>/download">Download Demand</a>
					<% } %>
					<div class="dropdown-divider"></div>
					<a class="dropdown-item" href="/stores/demands">Back to Demands</a>
				</div>
				<% if (permissions.demands_delete) { %>
					<div class="col-12 mb-3">
						<form action="/stores/demands/<%= demands.demand_id %>?_method=DELETE" method="POST" onsubmit="return confirm('Confirm delete demand?');">
							<button class="btn btn-danger">Delete Demand</button>
						</form>
					</div>
				<% } %>
			</li>
		</ul>
	</nav>
</section>
<section class="container pt-3">
	<div class="row">
		<div class="col-12 col-lg-6 col-xl-4 mb-3 bordered">
			<h4>Details</h4>
			<div class="row">
				<div class="col-sm-4">
					<label class="col-form-label">Supplier:</label>
				</div>
				<div class="col-sm-8">
					<input class="form-control" type="text" value="<%= demand.supplier._name %>" readonly>
				</div>
			</div>
			<div class="row">
				<div class="col-sm-4">
					<label class="col-form-label">Raised By:</label>
				</div>
				<div class="col-sm-8">
						<input class="form-control" type="text" value="<%= demand.user.rank._rank %> <%= demand.user._name %>, <%= demand.user._ini %>" readonly>
				</div>
			</div>
			<div class="row">
				<div class="col-sm-4">
					<label class="col-form-label">Date:</label>
				</div>
				<div class="col-sm-8">
					<input class="form-control" type="text" value="<%= demand._date.toDateString() %>" readonly>
				</div>
			</div>
			<div class="row">
				<div class="col-sm-4">
					<label class="col-form-label">Complete:</label>
				</div>
				<div class="col-sm-8">
					<input class="form-control form-control-sm" type="checkbox" disabled<% if (demand._complete) { %> checked<% } %>>
				</div>
			</div>
		</div>
		<% if (permissions.access_notes) { %> 
			<div class="col-12 col-lg-6 col-xl-8 mb-3 bordered">
				<% include ../../partials/noteTable %>
			</div>
		<% } %>
		<div class="col-12 col-lg-6 col-xl-12 mb-3 bordered">
			<div class="row">
				<div class="col-3">
					<label class="col-form-label text-right" for="rl">Received Lines:</label>
				</div>
				<div class="col-9">
					<select id="rl" class='form-control form-control-sm' type="text" onchange=filterSelects()>
						<option value="1" <% if (query.rl === 1) { %>selected<% } %> >Include</option>
						<option value="2" <% if (query.rl === 2) { %>selected<% } %> >Exclude</option>
						<option value="3" <% if (query.rl === 3) { %>selected<% } %> >Only</option>
					</select>
				</div>
			</div>
			<form id="requestForm" action="/stores/demands/<%= demand.demand_id %>/action?_method=PUT" method="POST" onsubmit="return confirm('Confirm action selected lines?');">
				<button class="btn btn-success w-100 mb-3">Action Selected Lines</button>
				<table id="demandTable" class="table table-sm table-hover mx-auto w-100">
					<thead class="thead-dark">
						<th class="w-20" onclick="sortTable(0, 'demandTable')">Item</th>
						<th class="w-10" onclick="sortTable(1, 'demandTable')">Size</th>
						<th class="w-5"  onclick="sortTable(2, 'demandTable')">Quantity</th>
						<th class="w-10" onclick="sortTable(3, 'demandTable')">Action</th>
						<th class="w-5"  onclick="sortTable(5, 'demandTable')">Location</th>
					</thead>
					<tbody>
						<% if (demand.lines) { %>
							<% demand.lines.forEach(line => { %>
								<tr>
									<td><a href="/stores/items/<%= line.item_size.item_id %>"> <%= line.item_size.item._description %></a></td>
									<td><a href="/stores/item_sizes/<%= line.item_size.itemsize_id %>"> <%= line.item_size.size._text %></a></td>
									<td><a href="#"> <%= line._qty %></a></td>
									<td>
										<% if (line._status === 'Cancelled' || line._status === 'Received') { %>
											<a href="#"><%= line._status %></a>
										<% } else { %>
											<select id="action<%= line.line_id %>" type="select" class="form-control form-control-sm" name="cancels[]" onchange=checkLocations(<%= line.line_id %>)>
												<option value=""></option>
												<option value="<%= line.line_id %>">Cancel</option>
												<option value="receive">Receive</option>
											</select>
										<% } %>
									</td>
									<td>
										<% if (line._status !== 'Received' && line.item_size.stocks) { %>
											<select style="display:none;" id="locations<%= line.line_id %>" class="form-control form-control-sm" name="receives[]">
												<option value=""></option>
												<% line.item_size.stocks.forEach(stock => { %>
													<option value='{"line_id": <%= line.line_id %>,"stock_id":<%= stock.stock_id %>}'><%= stock.location._location %></option>
												<% }) %>
											</select>
										<% } %>
									</td>
								</tr>
							<% }) %>
						<% } %>
					</tbody>
				</table>
			</form>
		</div>
	</div>
</section>
<% include ../../partials/foot/full %>
<script src="/js/filters.js"></script>
<script>
    function filterSelects() {
        filter(['rl', 'sn'], "/stores/demands/<%= demand.demand_id %>");
    };
	function checkLocations(line) {
		var action    = document.querySelector('#action' + line),
			locations = document.querySelector('#locations' + line);
		if (action.value === 'receive') {
			locations.style.display = 'block';
		} else {
			locations.style.display = 'none';
		};
	};
</script>
<% include ../../partials/foot/htmlClose %>