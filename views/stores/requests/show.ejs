<%- include(`${process.env.PARTIALS}/head/full`) %>
<section class="mb-2">
	<nav class="navbar navbar-expand navbar-light bg-nav">
		<ul class="navbar-nav mr-auto">
            <%- include(`${process.env.PARTIALS}/breadcrumb`, {href: '/stores',		  	 text: 'Stores'}) %>
			<%- include(`${process.env.PARTIALS}/breadcrumb`, {href: '/stores/requests', text: 'Requests'}) %>
			<%- include(`${process.env.PARTIALS}/breadcrumb`) %> 
		</ul>
	</nav>
</section>
<section class="container">
	<% if (!request._complete) { %>
		<div id='incompleteToast' role="alert" aria-live="assertive" aria-atomic="true" class="toast float-right" data-autohide="false">
			<div class="toast-header">
				<strong class="mr-auto">Incomplete Request</strong>
				<button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="toast-body toast-warn">
				This request is still in progress, no items on this request will be actioned or considered until the request is marked as 'Complete'
			</div>
		</div>
	<% } %>
	<ul class="nav nav-tabs" id="mainTab" role="tablist">
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Menu
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
				<% if (permissions.request_edit && request._complete && !request._closed && user.user_id !== request._for.user_id) { %>
					<button form='approveForm' class="dropdown-item dropdown_button confirm">
						Action Lines
					</button>
				<% } %>
                <%- include(`${process.env.PARTIALS}/notes/menu_add`) %>
				<% if (!request._complete && !request._closed) { %>
					<% if (permissions.request_edit) { %>
						<form id='completeForm'>
							<button class="dropdown-item dropdown_button confirm">
								Complete
							</button>
						</form>
					<% }; %>
					<% if (permissions.request_line_add) { %>
						<a class="dropdown-item" href='javascript:addSize("request",<%= request.request_id %>)'>
							Add Item
						</a>
					<% } %>
					<div class="dropdown-divider"></div>
					<% if (permissions.request_delete) { %>
						<form id='deleteForm'>
							<button class="dropdown-item dropdown_button confirm">
								Delete
							</button>
						</form>
					<% } %>
				<% } %>
            </div>
        </li>
        <%- include(`${process.env.PARTIALS}/tab_head`, {id: 'details', title: 'Details'}) %>
        <%- include(`${process.env.PARTIALS}/tab_head`, {id: 'lines',   title: 'Lines', count_id: 'line_count'}) %>
        <%- include(`${process.env.PARTIALS}/tab_head`, {id: 'notes',   title: 'Notes', count_id: 'note_count', permission: 'access_notes'}) %>
        <%- include(`${process.env.PARTIALS}/reload`) %>
    </ul>
    <div class="tab-content pt-3" id="myTabContent">
        <div class="tab-pane fade" id="details" role="tabpanel" aria-labelledby="details-tab">
			<%- include(`${process.env.PARTIALS}/spinner`, {id: 'requests'}) %>
			<%- include(`${process.env.PARTIALS}/inputs/display`, {id: '_for',  	title: 'For'}) %>
			<%- include(`${process.env.PARTIALS}/inputs/display`, {id: '_by',   	title: 'By'}) %>
			<%- include(`${process.env.PARTIALS}/inputs/display`, {id: '_date', 	title: 'Date'}) %>
			<%- include(`${process.env.PARTIALS}/inputs/display`, {id: '_complete', title: 'Complete'}) %>
			<%- include(`${process.env.PARTIALS}/inputs/display`, {id: '_closed',   title: 'Closed'}) %>
		</div>
        <div class="tab-pane fade" id="lines" role="tabpanel" aria-labelledby="lines-tab">
			<% if (permissions.request_edit && request._complete && !request._closed && user.user_id !== request._for.user_id) { %>
				<form id='approveForm'>
			<% } %>
			<% if (request._complete) { %>
				<%- include(`${process.env.PARTIALS}/inputs/select`, {title: 'Status', id: 'sel_status', options: [{value: '', text: 'All', selected: true}, {value: '_status=Open', text: 'Open'}, {value: '_status=Approved', text: 'Approved'}, {value: '_status=Declined', text: 'Declined'}, {value: '_status=Cancelled', text: 'Cancelled'}]}) %>
			<% } %>
			<table class="table table-sm table-hover mx-auto w-100">
				<thead class="thead-dark">
					<th class="w-<% if (request._complete) { %>20<% } else { %>30<% } %>" onclick="sortTable(0, 'requestTable')"><%- include(`${process.env.PARTIALS}/spinner`, {id: 'request_lines', spinner_sm: true, spinner_float_left: true}) %>Item</th>
					<th class="w-<% if (request._complete) { %>20<% } else { %>30<% } %>" onclick="sortTable(1, 'requestTable')">Size</th>
					<th class="w-<% if (request._complete) { %>5<% } else { %>15<% } %>"  onclick="sortTable(2, 'requestTable')">Qty</th>
					<th class="w-<% if (request._complete) { %>15<% } else { %>25<% } %>" onclick="sortTable(3, 'requestTable')">Status</th>
					<% if (request._complete) { %>
					<th class="w-20" onclick="sortTable(4, 'requestTable')">Date Approved</th>
					<th class="w-20" onclick="sortTable(5, 'requestTable')">Approved By</th>
					<% } %>
					<% if (permissions.request_line_delete && !request._complete) { %>
					<th><i class="fas fa-trash-alt"></i></th>
					<% } %>
				</thead>
				<tbody id="linesTable">
				</tbody>
			</table>
			<% if (permissions.request_edit && request._complete && !request._closed && user.user_id !== request._for.user_id) { %>
				</form>
			<% } %>
		</div>
        <%- include(`${process.env.PARTIALS}/notes/tab_body`) %>
    </div>
</section>
<%- include(`${process.env.PARTIALS}/foot/full`) %>
<!-- get/spinner/XHRsend/send from notes include -->
<script src='/js/tabs.js'></script>
<script src="/js/requests/show/request.js"></script>
<script src="/js/requests/show/lines.js"></script>
<script>showTab('<%= tab %>');</script>
<script>
	getRequest = () => {
		get(
			showRequest,
			{
				table: 'requests',
				query: [`request_id=${path[3]}`]
			}
		);
	};
</script>
<script async>getRequest()</script>
<script>
	let sel_status = document.querySelector('#sel_status');
    getLines = () => {
		get(
			showLines,
			{
				table: 'request_lines',
				query: [`request_id=${path[3]}`, sel_status.value],
				permissions: {
					edit: <%= permissions.request_line_edit || false %>,
					delete: <%= permissions.request_line_delete || false %>
				}
			}
		);
	};
    document.querySelector('#reload').addEventListener('click', () => getLines());
    document.querySelector('#reload').addEventListener('click', () => getRequest());
    document.querySelector('#sel_status').addEventListener('change', () => getLines());
</script>
<script async>getLines()</script>
<script>
    window.addEventListener( "load", () => {
		<% if (!request._complete && !request._closed) { %>
			<% if (permissions.request_delete) { %>
				addFormListener('deleteForm', 'DELETE', '/stores/requests/<%= request.request_id %>', {redirect: '/stores/requests'});
			<% } %>
			<% if (permissions.request_edit) { %>
				addFormListener('completeForm', 'PUT', '/stores/requests/<%= request.request_id %>', {reload: true});
			<% } %>
		<% } %>
		<% if (permissions.request_edit && request._complete && !request._closed && user.user_id !== request._for.user_id) { %>
			addFormListener('approveForm', 'PUT', '/stores/request_lines/<%= request.request_id %>', {reload: true});
		<% } %>
	});
	<% if (!request._complete) { %>
		$('#incompleteToast').toast('show')
	<% } %>
</script>
<!-- <script async>getRequestLines(<%= request.request_id %>, <%= request._complete %>, <% if (permissions.request_line_edit) { %>1<% } else { %>0<% } %>, <% if (permissions.request_line_delete) { %>1<% } else { %>0<% } %>)</script> -->
<%- include(`${process.env.PARTIALS}/foot/htmlClose`) %>