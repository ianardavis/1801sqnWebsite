<%- include(`${partials}/head/app`) %>
<%- include(`${partials}/breadcrumb`, {href: '/stores',		  	 text: 'Stores'}) %>
<%- include(`${partials}/breadcrumb`, {href: '/stores/requests', text: 'Requests'}) %>
<%- include(`${partials}/breadcrumb`) %>
<%- include(`${partials}/reload`) %>
<%- include(`${partials}/head/navbar/close`) %>
<section class="container">
	<ul class="nav nav-tabs" id="mainTab" role="tablist">
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Menu
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                <%- include(`${partials}/notes/menu_add`) %>
				<button id='btn_action' form='form_action' class='dropdown-item confirm' disabled>Action Lines</button>
				<form id='form_complete'>
					<button id='btn_complete' class='dropdown-item confirm' disabled>Complete</button>
				</form>
				<%- include(`${partials}/stores/sizes/select_button`, {permission: 'request_line_add'}) %>
				<div class="dropdown-divider"></div>
				<form id='form_delete'>
					<button id='btn_delete' class="dropdown-item confirm" disabled>Cancel</button>
				</form>
            </div>
        </li>
        <%- include(`${partials}/tab_head`, {id: 'details', title: 'Details', spinner: 'request'}) %>
        <%- include(`${partials}/tab_head`, {id: 'lines',   title: 'Lines',	  spinner: 'request_lines', count_id: 'line'}) %>
        <%- include(`${partials}/tab_head`, {id: 'notes',   title: 'Notes',	  spinner: 'notes', 		count_id: 'note', permission: 'access_notes'}) %>
    </ul>
    <div class="tab-content pt-3" id="myTabContent">
        <div class="tab-pane fade" id="details" role="tabpanel" aria-labelledby="details-tab">
			<%- include(`${partials}/spinner`, {id: 'requests'}) %>
			<%- include(`${partials}/inputs/display`, {id: 'user_for', 	title: 'For', link: true}) %>
			<%- include(`${partials}/inputs/display`, {id: 'user_by', 	title: 'By',  link: true}) %>
			<%- include(`${partials}/inputs/display`, {id: 'createdAt', title: 'Date'}) %>
			<%- include(`${partials}/inputs/display`, {id: 'updatedAt', title: 'Last Updated'}) %>
			<%- include(`${partials}/inputs/display`, {id: '_status',   title: 'Status'}) %>
		</div>
        <div class="tab-pane fade" id="lines" role="tabpanel" aria-labelledby="lines-tab">
			<% if (permissions.request_line_edit) { %>
				<form id='form_action'>
			<% } %>
			<%- include(`${partials}/inputs/select`, {title: 'Status', id: 'sel_status', options: [{value: '', text: 'All', selected: true}, {value: '_status=0', text: 'Cancelled'}, {value: '_status=1', text: 'Pending'}, {value: '_status=2', text: 'Open'}, {value: '_status=3', text: 'Approved'}, {value: '_status=4', text: 'Declined'}]}) %>
			<table class="table table-sm table-hover mx-auto w-100">
				<thead id='table_header_lines' class="thead-dark">
					<th class='w-35' onclick="sortTable(1,'tbl_lines')">Item</th>
					<th class='w-35' onclick="sortTable(2,'tbl_lines')">Size</th>
					<th class='w-10' onclick="sortTable(3,'tbl_lines')">Qty</th>
					<th class='w-20' onclick="sortTable(4,'tbl_lines')">Status</th>
					<th id='col_view'><i class='fas fa-search'></i></th>
				</thead>
				<tbody id="tbl_lines"></tbody>
			</table>
			<% if (permissions.request_line_edit) { %>
				</form>
			<% } %>
		</div>
        <%- include(`${partials}/notes/tab_body`) %>
	</div>
	<div id="div_modals">
		<%- include(`${partials}/stores/sizes/select`, {permission: 'request_line_add'}) %>
		<% if (permissions.access_request_lines) { %>
			<div id='mdl_line_view' class="modal fade" tabindex="-1" role="dialog">
				<div class="modal-dialog modal-lg" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title">Request Line <span id="line_id_view"></span></h5>
						</div>
						<div class="modal-body">
							<ul class="nav nav-tabs" role="tablist">
								<%- include(`${partials}/tab_head`, {id: 'request_line', 	    title: 'Details', 		spinner: 'request_line_view', active: true}) %>
								<%- include(`${partials}/tab_head`, {id: 'dates',  		 	    title: 'Dates/Actions', spinner: 'request_line_actions', count_id: 'line_actions'}) %>
								<%- include(`${partials}/tab_head`, {id: 'request_lines-notes', title: 'Notes',   		spinner: 'request_line_notes',	 count_id: 'request_lines_note', permission: 'access_notes'}) %>
							</ul>
							<div class="tab-content pt-3" id="myTabContent">
								<div class="tab-pane fade active show" id="request_line" role="tabpanel" aria-labelledby="request_line-tab">
									<%- include(`${partials}/inputs/display`, {title: 'Item', 	  	  id: 'line_item_view', link: true}) %>
									<%- include(`${partials}/inputs/display`, {title: 'Size', 	  	  id: 'line_size_view', link: true}) %>
									<%- include(`${partials}/inputs/display`, {title: 'Quantity', 	  id: 'line_qty_view'}) %>
									<%- include(`${partials}/inputs/display`, {title: 'Raised by',	  id: 'line_user_view', link: true}) %>
									<%- include(`${partials}/inputs/display`, {title: 'Raised',	  	  id: 'line_createdAt_view'}) %>
									<%- include(`${partials}/inputs/display`, {title: 'Last Updated', id: 'line_updatedAt_view'}) %>
								</div>
								<div class="tab-pane fade" id="dates" role="tabpanel" aria-labelledby="dates-tab">
									<table class="table table-sm table-hover mx-auto w-100">
										<thead id='table_header_lines' class="thead-dark">
											<th class='w-30' onclick="sortTable(0,'tbl_line_dates')">Date</th>
											<th class='w-40' onclick="sortTable(1,'tbl_line_dates')">Action</th>
											<th class='w-30' onclick="sortTable(2,'tbl_line_dates')">User</th>
											<th><i class='fas fa-search'></i></th>
										</thead>
										<tbody id="tbl_line_dates"></tbody>
									</table>
								</div>
								<%- include(`${partials}/notes/line_note_table`, {line: 'request_lines'}) %>
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
						</div>
					</div>
				</div>
			</div>
		<% } %>
	</div>
</section>
<%- include(`${partials}/foot/app`) %>
<!-- get/spinner/XHRsend/send from notes include -->
<script src='/js/tabs.js'></script>
<script src='/js/addSize.js'></script>
<script src="/js/stores/nsns/list.js"></script>
<script src="/js/stores/stock/list.js"></script>
<script src="/js/stores/serials/list.js"></script>
<script src="/js/search/select.js"></script>
<script src='/js/data/addFormListener.js'></script>
<script>showTab('<%= tab %>')</script>
<script src="/js/stores/requests/show/request.js"></script>
<script async>getRequest()</script>
<% if (permissions.request_edit) { %>
	<script src="/js/stores/requests/show/requestEdit.js"></script>
	<script async>setRequestButtons()</script>
	<script>
		window.addEventListener( "load", () => {
			addFormListener(
				'form_complete',
				'PUT',
				`/stores/requests/${path[3]}`,
				{
					onComplete: [
						getRequest,
						getLines
					]
				}
			);
		});
	</script>
<% } %>
<% if (permissions.access_request_lines) { %>
	<script src="/js/stores/requests/show/lines.js"></script>
	<script>let lines_loaded = false;</script>
	<script async>getLines()</script>
	<% if (permissions.access_notes) { %>
		<script>
            set_attribute({id: 'btn_request_lines_note_add', attribute: 'data-source', value: 'line_view'});
			$('#mdl_line_view').on('show.bs.modal', function (event) {
				set_attribute({id: 'btn_request_lines_note_add', attribute: 'data-_table', value: 'request_lines'});
				set_attribute({id: 'btn_request_lines_note_add', attribute: 'data-_id',    value: event.relatedTarget.dataset.request_line_id});
				getLineNotes({
					line_id: 'request_lines',
					table: 	 'request_lines',
					id:		 event.relatedTarget.dataset.request_line_id
				})
			});
		</script>
	<% } %>
	<% if (permissions.request_line_add) { %>
		<script src="/js/stores/requests/show/lineAdd.js"></script>
	<% } %>
	<% if (permissions.request_line_edit) { %>
		<script src="/js/stores/requests/show/lineEdit.js"></script>
		<script>
			function setActions() {
				let actions_interval = window.setInterval(
					function () {
						if (lines_loaded === true) {
							getLineActions();
							clearInterval(actions_interval);
						}
					},
					500
				);
			};
			document.querySelector('#reload').addEventListener('click', setActions);
		</script>
		<script async>setActions()</script>
		<script async>setLineButtons()</script>
		<script>
			window.addEventListener( "load", () => {
				addFormListener(
					'form_action',
					'PUT',
					`/stores/request_lines/${path[3]}`,
					{
						onComplete: [
							getLines,
							setActions,
							setLineButtons
						]
					}
				);
			});
		</script>
	<% } %>
<% } %>
<% if (permissions.request_delete) { %>
	<script>
		window.addEventListener( "load", () => {
			addFormListener(
				'form_delete',
				'DELETE',
				`/stores/requests/${path[3]}`,
				{
					onComplete: [
						getRequest,
						getLines
					]
				}
			);
		});
	</script>
<% } %>
<%- include(`${partials}/foot/elements/htmlClose`) %>